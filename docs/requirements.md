# Discord GitHub連携Bot 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Discord GitHub Issue連携Bot

### 1.2 目的
DiscordチャンネルでのGitHub Issue参照を効率化し、開発チームのコミュニケーションを向上させる

### 1.3 背景
- 現在のGitHubチャンネルはプッシュ型（GitHub→Discord）
- チャンネル横断でのIssue参照が困難
- Issue内容の即座確認ができない

## 2. 機能要件

### 2.1 Issue番号認識機能
**概要**: メッセージ内のIssue番号を自動検出

**詳細仕様**:
- 対応パターン:
  - `#123` (ハッシュタグ + 数字)
  - `git#123` (git + ハッシュタグ + 数字)
- 認識条件:
  - 数字は1-99999の範囲
  - 前後にスペースまたは文頭/文末
  - 1メッセージ内で複数Issue番号対応
- 除外条件:
  - URLの一部として含まれる場合
  - コードブロック内
  - 引用内

### 2.2 GitHub API連携機能
**概要**: GitHub REST APIを使用したIssue情報取得

**詳細仕様**:
- 取得データ:
  - Issue タイトル
  - Issue 本文（最初の200文字）
  - 状態（Open/Closed）
  - 作成者
  - 作成日時
  - 更新日時
  - ラベル一覧
  - コメント数
  - アサイン先
- API制限対応:
  - レート制限監視
  - リトライ機能
  - キャッシュ機能（5分間）

### 2.3 リアルタイムプレビュー表示機能
**概要**: Discord Embedを使用したリッチな表示

**詳細仕様**:
- 表示形式: Discord Embed
- 表示内容:
  - ヘッダー: Issue番号 + タイトル
  - 説明: Issue本文抜粋
  - フィールド:
    - 状態（色付きステータス）
    - 作成者
    - 作成日
    - ラベル（色付きタグ）
    - コメント数
  - フッター: GitHub Issue へのリンク
- 色分け:
  - Open Issue: 緑色
  - Closed Issue: 赤色
  - Draft: 黄色

### 2.4 チャンネル横断機能
**概要**: 全てのチャンネルでIssue参照可能

**詳細仕様**:
- 対象チャンネル: サーバー内全チャンネル
- 権限制御: チャンネル閲覧権限に準拠
- ログ記録: 使用統計の収集

## 3. 非機能要件

### 3.1 パフォーマンス要件
- レスポンス時間: 3秒以内（95%ile）
- 同時処理: 50リクエスト/秒
- キャッシュヒット率: 70%以上

### 3.2 可用性要件
- 稼働率: 99.5%以上
- 障害復旧時間: 5分以内
- データバックアップ: 日次自動実行

### 3.3 セキュリティ要件
- GitHubトークン暗号化保存
- 通信はHTTPS必須
- ログの個人情報マスキング

### 3.4 運用要件
- ログレベル: INFO, WARN, ERROR
- 監視項目: レスポンス時間、エラー率
- アラート: エラー率5%超過時

## 4. システム制約

### 4.1 技術制約
- Node.js 18以上
- Discord.js v14
- GitHub API v4（REST）
- SQLite3（設定保存）

### 4.2 外部API制約
- GitHub API制限: 5000リクエスト/時
- Discord API制限: 50リクエスト/秒

### 4.3 環境制約
- 対象OS: macOS（M2チップ）
- メモリ使用量: 512MB以下
- ディスク使用量: 100MB以下

## 5. インターフェース要件

### 5.1 Discord インターフェース
**入力**:
```
通常メッセージに #123 または git#123 を含む
```

**出力**:
```
Discord Embed形式でのIssue情報表示
```

### 5.2 GitHub API インターフェース
**エンドポイント**:
```
GET /repos/{owner}/{repo}/issues/{issue_number}
```

**認証**:
```
Personal Access Token
```

### 5.3 設定管理インターフェース
**コマンド例**:
```
!github set-repo owner/repository-name
!github list-repos
!github remove-repo owner/repository-name
```

## 6. データ要件

### 6.1 設定データ
- サーバーID
- リポジトリ情報（owner/repo）
- 有効/無効フラグ
- 作成日時

### 6.2 キャッシュデータ
- Issue情報
- 取得日時
- TTL（5分）

### 6.3 ログデータ
- 実行ログ
- エラーログ
- 使用統計

## 7. エラーハンドリング

### 7.1 GitHub API エラー
- Issue不存在: 「Issue #123 が見つかりません」
- リポジトリ不存在: 「リポジトリが設定されていません」
- 権限エラー: 「アクセス権限がありません」
- レート制限: 「しばらく時間をおいて再試行してください」

### 7.2 Discord API エラー
- 権限不足: ログ出力のみ（ユーザーに通知しない）
- 送信制限: キュー処理で対応

### 7.3 内部エラー
- DB接続エラー: フォールバック処理
- 設定エラー: デフォルト設定で継続

## 8. セキュリティ要件

### 8.1 認証・認可
- GitHub Personal Access Token
- Discord Bot Token
- サーバー管理者による設定変更制限

### 8.2 データ保護
- トークン暗号化保存
- ログの機密情報マスキング
- 通信の暗号化

## 9. 運用要件

### 9.1 監視・ログ
- アプリケーションログ
- パフォーマンス監視
- エラー監視

### 9.2 バックアップ・復旧
- 設定データの定期バックアップ
- 障害時の自動復旧

## 10. 成功基準

### 10.1 機能面
- Issue番号認識率: 95%以上
- 表示成功率: 98%以上
- レスポンス時間: 平均2秒以下

### 10.2 運用面
- 稼働率: 99.5%以上
- ユーザー満足度: 8/10以上
- 運用工数: 週1時間以下

## 11. リスク分析

### 11.1 技術リスク
- GitHub API制限による機能停止
- Discord API変更による互換性問題

### 11.2 運用リスク
- 大量リクエストによるサーバー負荷
- 不正利用によるAPI制限

### 11.3 対策
- キャッシュ機能による負荷軽減
- レート制限監視とアラート
- 定期的なAPI仕様確認